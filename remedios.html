<!DOCTYPE html>
<html lang="pt-BR" class="no-js">
<head>
  <script src="assets/js/authGuard.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BabyCare ‚Äî Rem√©dios</title>
  <meta name="description" content="Gerenciamento de rem√©dios e medica√ß√µes.">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/responsive.css">
  <link rel="stylesheet" href="assets/css/animation.css">
  <style>
    dialog { 
      border: none; 
      border-radius: 16px; 
      padding: 25px; 
      width: 90%; 
      max-width: 450px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    }
    dialog::backdrop { background-color: rgba(0, 0, 0, 0.6); }
    
    .dialog-form { display: flex; flex-direction: column; gap: 15px; }
    .dialog-form h2 { margin: 0 0 10px 0; color: #333; }
    .dialog-form input, .dialog-form select, .dialog-form textarea { 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 14px; 
      font-family: 'Poppins', sans-serif;
    }
    .dialog-form textarea { resize: vertical; min-height: 80px; }
    .dialog-form label { font-size: 13px; color: #666; margin-bottom: -10px; font-weight: 500; }
    
    .checkbox-container {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .checkbox-container input[type="checkbox"] {
      width: 20px;
      height: 20px;
      cursor: pointer;
    }
    
    .form-actions { 
      display: flex; 
      justify-content: flex-end; 
      gap: 10px; 
      margin-top: 10px; 
    }
    .btn { 
      cursor: pointer; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 14px;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-success { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-small { padding: 6px 12px; font-size: 13px; }
    
    .add-button { 
      position: fixed; 
      bottom: 30px; 
      right: 30px; 
      width: 60px; 
      height: 60px; 
      border-radius: 50%; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border: none; 
      font-size: 30px; 
      cursor: pointer; 
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
      z-index: 100;
    }
    .add-button:hover { 
      transform: scale(1.1) rotate(90deg); 
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .medicine-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    .medicine-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .medicine-card.inactive {
      opacity: 0.6;
      background: #f8f9fa;
    }
    .medicine-header {
      display: flex;
      justify-content: space-between;
      align-items: flex-start;
      margin-bottom: 12px;
    }
    .medicine-info h3 {
      margin: 0 0 5px 0;
      color: #2c3e50;
      font-size: 18px;
    }
    .medicine-info .child-name {
      color: #7f8c8d;
      font-size: 14px;
      font-weight: 500;
    }
    .medicine-badge {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      padding: 6px 12px;
      border-radius: 20px;
      font-size: 12px;
      font-weight: 600;
    }
    .medicine-badge.inactive {
      background: #95a5a6;
    }
    .medicine-details {
      color: #555;
      font-size: 14px;
      line-height: 1.6;
      margin-bottom: 12px;
    }
    .medicine-meta {
      display: flex;
      gap: 15px;
      color: #95a5a6;
      font-size: 13px;
      margin-bottom: 12px;
      flex-wrap: wrap;
    }
    .medicine-actions {
      display: flex;
      gap: 8px;
      justify-content: flex-end;
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #95a5a6;
      display: block !important;
    }
    .empty-state img {
      width: 120px;
      opacity: 0.3;
      margin-bottom: 20px;
    }
    
    #remedios-list {
      display: block !important;
      visibility: visible !important;
    }
  </style>
</head>

<body>
  <header class="bc-header">
    <div class="bc-header__wrap">
      <a class="bc-icon-btn" href="index.html" aria-label="Voltar ao menu">
        <img src="assets/img/icons/sair.png" alt="Voltar"/> 
      </a>
      <h1 class="bc-header__title">REM√âDIOS</h1>
      <div class="bc-user-info" style="display: flex; align-items: center; gap: 10px;">
        <span id="user-name-header" style="color: white; font-size: 14px; font-weight: 500;">Carregando...</span>
        <img id="user-avatar" src="" alt="Avatar do usu√°rio" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;" />
      </div>
    </div>
  </header>

  <main class="bc-main" style="padding-bottom: 100px;">
    <section id="remedios-list" class="reveal" style="margin-top:16px; padding: 0 16px; min-height: 200px;">
      <!-- Os rem√©dios ser√£o inseridos aqui dinamicamente -->
    </section>
  </main>

  <!-- Bot√£o flutuante para adicionar -->
  <button class="add-button" id="show-create-modal" aria-label="Adicionar rem√©dio">+</button>

  <!-- Modal para criar rem√©dio -->
  <dialog id="create-medicine-dialog">
    <form id="create-medicine-form" class="dialog-form">
      <h2>üíä Novo Rem√©dio</h2>
      
      <label for="create-crianca">Crian√ßa</label>
      <select id="create-crianca" name="crianca_id" required>
        <option value="">Selecione uma crian√ßa...</option>
      </select>
      
      <label for="create-nome">Nome do Rem√©dio</label>
      <input type="text" id="create-nome" name="nome" placeholder="Ex: Paracetamol, Ibuprofeno..." required>
      
      <label for="create-horario">Hor√°rio</label>
      <input type="time" id="create-horario" name="horario" required>
      
      <label for="create-dosagem">Dosagem</label>
      <input type="text" id="create-dosagem" name="dosagem" placeholder="Ex: 5ml, 1 comprimido...">
      
      <label for="create-observacoes">Observa√ß√µes</label>
      <textarea id="create-observacoes" name="observacoes" placeholder="Informa√ß√µes adicionais..."></textarea>
      
      <div class="checkbox-container">
        <input type="checkbox" id="create-ativo" name="ativo" checked>
        <label for="create-ativo" style="margin: 0;">Medica√ß√£o ativa</label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-create">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal para editar rem√©dio -->
  <dialog id="update-medicine-dialog">
    <form id="update-medicine-form" class="dialog-form">
      <h2>‚úèÔ∏è Editar Rem√©dio</h2>
      <input type="hidden" id="update-id" name="id">
      
      <label for="update-crianca">Crian√ßa</label>
      <select id="update-crianca" name="crianca_id" required>
        <option value="">Selecione uma crian√ßa...</option>
      </select>
      
      <label for="update-nome">Nome do Rem√©dio</label>
      <input type="text" id="update-nome" name="nome" placeholder="Ex: Paracetamol..." required>
      
      <label for="update-horario">Hor√°rio</label>
      <input type="time" id="update-horario" name="horario" required>
      
      <label for="update-dosagem">Dosagem</label>
      <input type="text" id="update-dosagem" name="dosagem" placeholder="Ex: 5ml...">
      
      <label for="update-observacoes">Observa√ß√µes</label>
      <textarea id="update-observacoes" name="observacoes" placeholder="Informa√ß√µes adicionais..."></textarea>
      
      <div class="checkbox-container">
        <input type="checkbox" id="update-ativo" name="ativo">
        <label for="update-ativo" style="margin: 0;">Medica√ß√£o ativa</label>
      </div>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-update">Cancelar</button>
        <button type="submit" class="btn btn-primary">Atualizar</button>
      </div>
    </form>
  </dialog>

  <script>
    const API_URL = 'http://localhost:3000/api';
    
    const remediosContainer = document.getElementById('remedios-list');
    const createDialog = document.getElementById('create-medicine-dialog');
    const updateDialog = document.getElementById('update-medicine-dialog');
    const createForm = document.getElementById('create-medicine-form');
    const updateForm = document.getElementById('update-medicine-form');
    
    let criancasCache = [];
    
    // Controles dos modais
    document.getElementById('show-create-modal').addEventListener('click', () => {
      populateChildrenSelect('create-crianca');
      createDialog.showModal();
    });
    document.getElementById('cancel-create').addEventListener('click', () => createDialog.close());
    document.getElementById('cancel-update').addEventListener('click', () => updateDialog.close());
    
    // Carregar lista de crian√ßas
    async function loadChildren() {
      console.log('üîÑ Carregando lista de crian√ßas...');
      try {
        const response = await fetch(`${API_URL}/criancas`, { credentials: 'include' });
        console.log('üì° Resposta do servidor:', response.status);
        if (response.ok) {
          criancasCache = await response.json();
          console.log('‚úÖ Crian√ßas carregadas:', criancasCache.length);
        } else {
          console.warn('‚ö†Ô∏è Erro ao carregar crian√ßas:', response.status);
        }
      } catch (error) {
        console.error('‚ùå Erro ao carregar crian√ßas:', error);
      }
    }
    
    // Preencher select de crian√ßas
    function populateChildrenSelect(selectId) {
      const select = document.getElementById(selectId);
      select.innerHTML = '<option value="">Selecione uma crian√ßa...</option>';
      criancasCache.forEach(child => {
        const option = document.createElement('option');
        option.value = child.id;
        option.textContent = child.nome;
        select.appendChild(option);
      });
    }
    
    // Buscar nome da crian√ßa
    function getChildName(criancaId) {
      const child = criancasCache.find(c => c.id === criancaId);
      return child ? child.nome : 'Crian√ßa n√£o encontrada';
    }
    
    // Criar rem√©dio
    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const formData = {
        crianca_id: document.getElementById('create-crianca').value,
        nome: document.getElementById('create-nome').value,
        horario: document.getElementById('create-horario').value,
        dosagem: document.getElementById('create-dosagem').value,
        observacoes: document.getElementById('create-observacoes').value,
        ativo: document.getElementById('create-ativo').checked
      };
      
      try {
        const response = await fetch(`${API_URL}/remedios`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro ao criar rem√©dio');
        }
        
        alert('‚úÖ Rem√©dio cadastrado com sucesso!');
        createForm.reset();
        document.getElementById('create-ativo').checked = true;
        createDialog.close();
        fetchMedicines();
      } catch (error) {
        alert('‚ùå Erro: ' + error.message);
      }
    });
    
    // Atualizar rem√©dio
    updateForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const id = document.getElementById('update-id').value;
      
      const formData = {
        crianca_id: document.getElementById('update-crianca').value,
        nome: document.getElementById('update-nome').value,
        horario: document.getElementById('update-horario').value,
        dosagem: document.getElementById('update-dosagem').value,
        observacoes: document.getElementById('update-observacoes').value,
        ativo: document.getElementById('update-ativo').checked
      };
      
      try {
        const response = await fetch(`${API_URL}/remedios/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('Falha ao atualizar.');
        
        alert('‚úÖ Rem√©dio atualizado!');
        updateDialog.close();
        fetchMedicines();
      } catch (error) {
        alert('‚ùå ' + error.message);
      }
    });
    
    // Mostrar modal de edi√ß√£o
    function showUpdateModal(medicine) {
      document.getElementById('update-id').value = medicine.id;
      populateChildrenSelect('update-crianca');
      document.getElementById('update-crianca').value = medicine.crianca_id;
      document.getElementById('update-nome').value = medicine.nome || '';
      document.getElementById('update-horario').value = medicine.horario || '';
      document.getElementById('update-dosagem').value = medicine.dosagem || '';
      document.getElementById('update-observacoes').value = medicine.observacoes || '';
      document.getElementById('update-ativo').checked = medicine.ativo;
      updateDialog.showModal();
    }
    
    // Deletar rem√©dio
    async function deleteMedicine(id) {
      if (!confirm('üóëÔ∏è Tem certeza que deseja excluir este rem√©dio?')) return;
      
      try {
        const response = await fetch(`${API_URL}/remedios/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Falha ao excluir.');
        alert('‚úÖ Rem√©dio exclu√≠do!');
        fetchMedicines();
      } catch (error) {
        alert('‚ùå ' + error.message);
      }
    }
    
    // Buscar e exibir rem√©dios
    async function fetchMedicines() {
      console.log('üíä Iniciando busca de rem√©dios...');
      remediosContainer.innerHTML = '<p style="text-align:center; color:#95a5a6; padding:40px;">Carregando...</p>';
      
      try {
        const response = await fetch(`${API_URL}/remedios`, { credentials: 'include' });
        console.log('üì° Resposta de rem√©dios:', response.status);
        
        if (response.status === 401) {
          console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado');
          remediosContainer.innerHTML = '<div class="empty-state"><p>Voc√™ n√£o est√° logado.</p></div>';
          return;
        }
        
        const medicines = await response.json();
        console.log('‚úÖ Rem√©dios recebidos:', medicines.length, medicines);
        remediosContainer.innerHTML = '';
        
        if (medicines.length === 0) {
          console.log('‚ÑπÔ∏è Nenhum rem√©dio encontrado');
          remediosContainer.innerHTML = `
            <div class="empty-state">
              <h3>Nenhum rem√©dio cadastrado</h3>
              <p>Clique no bot√£o + para adicionar um rem√©dio</p>
            </div>
          `;
          return;
        }
        
        medicines.forEach((medicine, index) => {
          console.log(`üîÑ Processando rem√©dio ${index + 1}:`, medicine);
          const childName = getChildName(medicine.crianca_id);
          const statusBadge = medicine.ativo 
            ? '<span class="medicine-badge">Ativo</span>' 
            : '<span class="medicine-badge inactive">Inativo</span>';
          
          const card = document.createElement('article');
          card.className = `medicine-card reveal ${!medicine.ativo ? 'inactive' : ''}`;
          card.innerHTML = `
            <div class="medicine-header">
              <div class="medicine-info">
                <h3>üíä ${medicine.nome}</h3>
                <p class="child-name">üë∂ ${childName}</p>
              </div>
              ${statusBadge}
            </div>
            <div class="medicine-meta">
              <span>‚è∞ ${medicine.horario}</span>
              ${medicine.dosagem ? `<span>üíâ ${medicine.dosagem}</span>` : ''}
            </div>
            ${medicine.observacoes ? `<div class="medicine-details">${medicine.observacoes}</div>` : ''}
            <div class="medicine-actions">
              <button class="btn btn-primary btn-small edit-btn">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger btn-small delete-btn">üóëÔ∏è Excluir</button>
            </div>
          `;
          
          card.querySelector('.edit-btn').addEventListener('click', () => showUpdateModal(medicine));
          card.querySelector('.delete-btn').addEventListener('click', () => deleteMedicine(medicine.id));
          
          remediosContainer.appendChild(card);
        });
        console.log('‚úÖ Todos os rem√©dios foram renderizados');
      } catch (error) {
        console.error('‚ùå Erro ao buscar rem√©dios:', error);
        remediosContainer.innerHTML = `<div class="empty-state"><p style="color: #e74c3c;">‚ùå Erro ao buscar rem√©dios: ${error.message}</p></div>`;
      }
    }
    
    // Carregar dados ao abrir a p√°gina
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ P√°gina carregada, iniciando sistema...');
      try {
        await loadChildren();
        await fetchMedicines();
        console.log('‚úÖ Sistema iniciado com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao inicializar:', error);
      }
    });
  </script>
  <script src="assets/js/script.js" defer></script>
</body>
</html>

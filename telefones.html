<!DOCTYPE html>
<html lang="pt-BR" class="no-js">
<head>
  <script src="assets/js/authGuard.js"></script>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <title>BabyCare ‚Äî Telefones de Emerg√™ncia</title>
  <meta name="description" content="Gerenciamento de contatos de emerg√™ncia.">
  <link rel="stylesheet" href="assets/css/style.css">
  <link rel="stylesheet" href="assets/css/responsive.css">
  <link rel="stylesheet" href="assets/css/animation.css">
  <style>
    dialog { 
      border: none; 
      border-radius: 16px; 
      padding: 25px; 
      width: 90%; 
      max-width: 450px; 
      box-shadow: 0 10px 25px rgba(0,0,0,0.2); 
    }
    dialog::backdrop { background-color: rgba(0, 0, 0, 0.6); }
    
    .dialog-form { display: flex; flex-direction: column; gap: 15px; }
    .dialog-form h2 { margin: 0 0 10px 0; color: #333; }
    .dialog-form input { 
      padding: 12px; 
      border: 1px solid #ddd; 
      border-radius: 8px; 
      font-size: 14px; 
      font-family: 'Poppins', sans-serif;
    }
    .dialog-form label { font-size: 13px; color: #666; margin-bottom: -10px; font-weight: 500; }
    
    .form-actions { 
      display: flex; 
      justify-content: flex-end; 
      gap: 10px; 
      margin-top: 10px; 
    }
    .btn { 
      cursor: pointer; 
      border: none; 
      padding: 10px 20px; 
      border-radius: 8px; 
      font-weight: 600; 
      font-size: 14px;
      transition: all 0.3s;
      font-family: 'Poppins', sans-serif;
    }
    .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 8px rgba(0,0,0,0.15); }
    .btn-primary { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }
    .btn-success { background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%); color: white; }
    .btn-danger { background: linear-gradient(135deg, #e74c3c 0%, #c0392b 100%); color: white; }
    .btn-secondary { background: #95a5a6; color: white; }
    .btn-small { padding: 6px 12px; font-size: 13px; }
    
    .add-button { 
      position: fixed; 
      bottom: 30px; 
      right: 30px; 
      width: 60px; 
      height: 60px; 
      border-radius: 50%; 
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); 
      color: white; 
      border: none; 
      font-size: 30px; 
      cursor: pointer; 
      box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
      transition: all 0.3s;
      z-index: 100;
    }
    .add-button:hover { 
      transform: scale(1.1) rotate(90deg); 
      box-shadow: 0 6px 20px rgba(102, 126, 234, 0.6);
    }
    
    .phone-card {
      background: white;
      border-radius: 16px;
      padding: 20px;
      margin-bottom: 16px;
      box-shadow: 0 2px 8px rgba(0,0,0,0.08);
      transition: all 0.3s;
      display: block !important;
      visibility: visible !important;
      opacity: 1 !important;
    }
    .phone-card:hover {
      box-shadow: 0 4px 16px rgba(0,0,0,0.12);
      transform: translateY(-2px);
    }
    .phone-header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 12px;
    }
    .phone-info h3 {
      margin: 0 0 5px 0;
      color: #2c3e50;
      font-size: 18px;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .phone-number {
      color: #667eea;
      font-size: 20px;
      font-weight: 700;
      letter-spacing: 1px;
    }
    .phone-actions {
      display: flex;
      gap: 8px;
    }
    .call-button {
      background: linear-gradient(135deg, #2ecc71 0%, #27ae60 100%);
      color: white;
      padding: 8px 16px;
      border-radius: 8px;
      text-decoration: none;
      font-weight: 600;
      font-size: 14px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      transition: all 0.3s;
    }
    .call-button:hover {
      transform: translateY(-2px);
      box-shadow: 0 4px 8px rgba(46, 204, 113, 0.4);
    }
    .empty-state {
      text-align: center;
      padding: 60px 20px;
      color: #95a5a6;
      display: block !important;
    }
    .empty-state img {
      width: 120px;
      opacity: 0.3;
      margin-bottom: 20px;
    }
    
    /* Garantir que a se√ß√£o seja vis√≠vel */
    #phones-list {
      display: block !important;
      visibility: visible !important;
    }
  </style>
</head>
<body>
  <header class="bc-header">
    <div class="bc-header__wrap">
      <a class="bc-icon-btn" href="index.html" aria-label="Voltar ao menu">
        <img src="assets/img/icons/sair.png" alt="Voltar"/> 
      </a>
      <h1 class="bc-header__title">EMERG√äNCIAS</h1>
      <div class="bc-user-info" style="display: flex; align-items: center; gap: 10px;">
        <span id="user-name-header" style="color: white; font-size: 14px; font-weight: 500;">Carregando...</span>
        <img id="user-avatar" src="" alt="Avatar do usu√°rio" style="width: 40px; height: 40px; border-radius: 50%; border: 2px solid white;" />
      </div>
    </div>
  </header>

  <main class="bc-main" style="padding-bottom: 100px;">
    <section id="phones-list" class="reveal" style="margin-top:16px; padding: 0 16px; min-height: 200px;">
      <!-- Os telefones ser√£o inseridos aqui dinamicamente -->
    </section>
  </main>

  <!-- Bot√£o flutuante para adicionar -->
  <button class="add-button" id="show-create-modal" aria-label="Adicionar telefone">+</button>

  <!-- Modal para criar telefone -->
  <dialog id="create-phone-dialog">
    <form id="create-phone-form" class="dialog-form">
      <h2>üìû Novo Contato de Emerg√™ncia</h2>
      
      <label for="create-nome">Nome do Contato</label>
      <input type="text" id="create-nome" name="nome_contato" placeholder="Ex: SAMU, Bombeiros, Hospital..." required>
      
      <label for="create-telefone">Telefone</label>
      <input type="tel" id="create-telefone" name="telefone" placeholder="Ex: 192, (11) 98765-4321..." required>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-create">Cancelar</button>
        <button type="submit" class="btn btn-success">Salvar</button>
      </div>
    </form>
  </dialog>

  <!-- Modal para editar telefone -->
  <dialog id="update-phone-dialog">
    <form id="update-phone-form" class="dialog-form">
      <h2>‚úèÔ∏è Editar Contato</h2>
      <input type="hidden" id="update-id" name="id">
      
      <label for="update-nome">Nome do Contato</label>
      <input type="text" id="update-nome" name="nome_contato" placeholder="Ex: SAMU..." required>
      
      <label for="update-telefone">Telefone</label>
      <input type="tel" id="update-telefone" name="telefone" placeholder="Ex: 192..." required>
      
      <div class="form-actions">
        <button type="button" class="btn btn-secondary" id="cancel-update">Cancelar</button>
        <button type="submit" class="btn btn-primary">Atualizar</button>
      </div>
    </form>
  </dialog>

  <script>
    const API_URL = 'https://babycare-api.onrender.com/api';
    
    const phonesContainer = document.getElementById('phones-list');
    const createDialog = document.getElementById('create-phone-dialog');
    const updateDialog = document.getElementById('update-phone-dialog');
    const createForm = document.getElementById('create-phone-form');
    const updateForm = document.getElementById('update-phone-form');
    
    // Controles dos modais
    document.getElementById('show-create-modal').addEventListener('click', () => createDialog.showModal());
    document.getElementById('cancel-create').addEventListener('click', () => createDialog.close());
    document.getElementById('cancel-update').addEventListener('click', () => updateDialog.close());
    
    // Criar telefone
    createForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      
      const formData = {
        nome_contato: document.getElementById('create-nome').value,
        telefone: document.getElementById('create-telefone').value
      };
      
      try {
        const response = await fetch(`${API_URL}/telefones-emergencia`, {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) {
          const errorData = await response.json();
          throw new Error(errorData.message || 'Erro ao criar contato');
        }
        
        alert('‚úÖ Contato cadastrado com sucesso!');
        createForm.reset();
        createDialog.close();
        fetchPhones();
      } catch (error) {
        alert('‚ùå Erro: ' + error.message);
      }
    });
    
    // Atualizar telefone
    updateForm.addEventListener('submit', async (event) => {
      event.preventDefault();
      const id = document.getElementById('update-id').value;
      
      const formData = {
        nome_contato: document.getElementById('update-nome').value,
        telefone: document.getElementById('update-telefone').value
      };
      
      try {
        const response = await fetch(`${API_URL}/telefones-emergencia/${id}`, {
          method: 'PUT',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify(formData)
        });
        
        if (!response.ok) throw new Error('Falha ao atualizar.');
        
        alert('‚úÖ Contato atualizado!');
        updateDialog.close();
        fetchPhones();
      } catch (error) {
        alert('‚ùå ' + error.message);
      }
    });
    
    // Mostrar modal de edi√ß√£o
    function showUpdateModal(phone) {
      document.getElementById('update-id').value = phone.id;
      document.getElementById('update-nome').value = phone.nome_contato || '';
      document.getElementById('update-telefone').value = phone.telefone || '';
      updateDialog.showModal();
    }
    
    // Deletar telefone
    async function deletePhone(id) {
      if (!confirm('üóëÔ∏è Tem certeza que deseja excluir este contato?')) return;
      
      try {
        const response = await fetch(`${API_URL}/telefones-emergencia/${id}`, {
          method: 'DELETE',
          credentials: 'include'
        });
        if (!response.ok) throw new Error('Falha ao excluir.');
        alert('‚úÖ Contato exclu√≠do!');
        fetchPhones();
      } catch (error) {
        alert('‚ùå ' + error.message);
      }
    }
    
    // Buscar e exibir telefones
    async function fetchPhones() {
      console.log('üìû Iniciando busca de telefones...');
      phonesContainer.innerHTML = '<p style="text-align:center; color:#95a5a6; padding:40px;">Carregando...</p>';
      
      try {
        const response = await fetch(`${API_URL}/telefones-emergencia`, { credentials: 'include' });
        console.log('üì° Resposta de telefones:', response.status);
        
        if (response.status === 401) {
          console.warn('‚ö†Ô∏è Usu√°rio n√£o autenticado');
          phonesContainer.innerHTML = '<div class="empty-state"><p>Voc√™ n√£o est√° logado.</p></div>';
          return;
        }
        
        const phones = await response.json();
        console.log('‚úÖ Telefones recebidos:', phones.length, phones);
        phonesContainer.innerHTML = '';
        
        if (phones.length === 0) {
          console.log('‚ÑπÔ∏è Nenhum telefone encontrado');
          phonesContainer.innerHTML = `
            <div class="empty-state">
              <h3>Nenhum contato cadastrado</h3>
              <p>Clique no bot√£o + para adicionar um contato de emerg√™ncia</p>
            </div>
          `;
          return;
        }
        
        phones.forEach((phone, index) => {
          console.log(`üîÑ Processando telefone ${index + 1}:`, phone);
          
          const card = document.createElement('article');
          card.className = 'phone-card reveal';
          card.innerHTML = `
            <div class="phone-header">
              <div class="phone-info">
                <h3>üìû ${phone.nome_contato}</h3>
                <p class="phone-number">${phone.telefone}</p>
              </div>
            </div>
            <div class="phone-actions">
              <a href="tel:${phone.telefone.replace(/\D/g, '')}" class="call-button">üì± Ligar</a>
              <button class="btn btn-primary btn-small edit-btn">‚úèÔ∏è Editar</button>
              <button class="btn btn-danger btn-small delete-btn">üóëÔ∏è Excluir</button>
            </div>
          `;
          
          card.querySelector('.edit-btn').addEventListener('click', () => showUpdateModal(phone));
          card.querySelector('.delete-btn').addEventListener('click', () => deletePhone(phone.id));
          
          phonesContainer.appendChild(card);
        });
        console.log('‚úÖ Todos os telefones foram renderizados');
      } catch (error) {
        console.error('‚ùå Erro ao buscar telefones:', error);
        phonesContainer.innerHTML = `<div class="empty-state"><p style="color: #e74c3c;">‚ùå Erro ao buscar telefones: ${error.message}</p></div>`;
      }
    }
    
    // Carregar dados ao abrir a p√°gina
    document.addEventListener('DOMContentLoaded', async () => {
      console.log('üöÄ P√°gina carregada, iniciando sistema...');
      try {
        await fetchPhones();
        console.log('‚úÖ Sistema iniciado com sucesso');
      } catch (error) {
        console.error('‚ùå Erro ao inicializar:', error);
      }
    });
  </script>
  <script src="assets/js/script.js" defer></script>
</body>
</html>